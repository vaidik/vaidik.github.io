<!doctype html>
<!-- https://github.com/paulirish/html5-boilerplate/blob/master/index.html -->
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="">

  <!-- encoding must be specified within the first 512 bytes
        www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#charset -->

  <!-- meta element for compatibility mode needs to be before
        all elements except title & meta
        msdn.microsoft.com/en-us/library/cc288325(VS.85).aspx -->
  <!-- Chrome Frame is only invoked if meta element for
        compatibility mode is within the first 1K bytes
        code.google.com/p/chromium/issues/detail?id=23003 -->

  <title>Problems with logging while using Gevent's WSGI Server</title>
  <meta name="description" content="Personal blog of Vaidik Kapoor.">
  <meta name="author" content="Vaidik Kapoor">

  <!--  Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="">

    <!-- Place favicon.ico & apple-touch-icon.png
        in the root of your domain and delete these references -->
  <link rel="shortcut icon" href="/media/favicon.ico">
  <link rel="apple-touch-icon" href="/media/apple-touch-icon.png">
  
  <!-- External Fonts -->
  <link href='http://fonts.googleapis.com/css?family=Mate+SC|Oxygen' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Balthazar' rel='stylesheet' type='text/css'>

  <!-- highlight.js -->
  <link rel="stylesheet" href="http://yandex.st/highlightjs/7.3/styles/default.min.css">
  <script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

    <link rel="stylesheet" href="/media/css/site.css">
  <link rel="stylesheet" href="/media/css/syntax.css">
  
    <!-- All JavaScript at the bottom, except for Modernizr which
        enables HTML5 elements & feature detects -->
    <script src="/media/js/libs/modernizr-1.7.min.js"></script>
    </head>
<body id="gevent-wsgi-logging-problems">
<!-- Qualaroo for vaidikkapoor.info -->
<!-- Paste this code right after the <body> tag on every page of your site. -->
<!--
<script type="text/javascript">
  var _kiq = _kiq || [];
  (function(){
    setTimeout(function(){
    var d = document, f = d.getElementsByTagName('script')[0], s = d.createElement('script'); s.type = 'text/javascript';
    s.async = true; s.src = '//s3.amazonaws.com/ki.js/56237/cqI.js'; f.parentNode.insertBefore(s, f);
    }, 1);
	})();
-->
<script id="_webengage_script_tag" type="text/javascript">
  var _weq = _weq || {};
  _weq['webengage.licenseCode'] = 'aa131265';
  _weq['webengage.widgetVersion'] = "4.0";
  
  (function(d){
    var _we = d.createElement('script');
    _we.type = 'text/javascript';
    _we.async = true;
    _we.src = (d.location.protocol == 'https:' ? "https://ssl.widgets.webengage.com" : "http://cdn.widgets.webengage.com") + "/js/widget/webengage-min-v-4.0.js";
    var _sNode = d.getElementById('_webengage_script_tag');
    _sNode.parentNode.insertBefore(_we, _sNode);
  })(document);
</script>
</script>
    <div id="container">
            <div id="main" role="main">
          <header class="clearfix">
              <h1>Vaidik Kapoor</h1>
                                          <nav >
        <a title="Home Page"
        class="home"
        href="/index.html">
        Home
    </a>    <a title="Blog Archives"
        class="active blog"
        href="/blog">
        Archives
    </a>    <a title="About"
        class="about"
        href="/about.html">
        About
    </a></nav>
              
          </header>

          <section class="content">
              <div class="post">
        <article>
            <aside>
                <time datetime="2015-02-01">
                    February 01, 2015
                </time>
            </aside>
            <section>
                <h2>
                    <a href="">Problems with logging while using Gevent's WSGI Server</a>
                </h2>
                <p>This article is about the logging problem with <a href="http://gevent.org/">Gevent&#8217;s</a> <a href="http://gevent.org/gevent.wsgi.html#gevent.wsgi.WSGIHandler"><span class="caps">WSGI</span>
Server</a> and how a simple hack can actually help you solve that problem
and make sure you continue to use Gevent for serving <span class="caps">WSGI</span> applications
(<a href="http://flask.pocoo.org/">Flask</a> in this article) without any&nbsp;compromises.</p>
<p>Flask comes really handy for writing internal services in <a href="http://www.python.org/">Python</a> because
it is batteries excluded, there is not too much of opinionated design decisions
that are pushed down your throat and that just makes it easy to do things your
way. I started working on a project a while back, for which I chose to use Flask
for precisely the same reasons. The project was an internal service that other
web applications in the stack would use to do a certain type of&nbsp;task.</p>
<p>This service is heavy on network and disk I/O. It would query large amounts of
data from another data store which would have data stored on the disk, and the
data is transferred to this application over the network. The service would then
do some processing of this data before it could send it in the&nbsp;response.</p>
<p>Since this application is mostly bound by I/O, every request would block the
next request. With a <a href="https://docs.python.org/2/library/wsgiref.html"><span class="caps">WSGI</span></a> server like <a href="http://gunicorn.org">Gunicorn</a>, you can only
get as far as the number of workers would take you. So I thought I can give a
try to a non-blocking <span class="caps">WSGI</span> web&nbsp;server.</p>
<p>First consideration was <a href="http://www.tornadoweb.org/">Tornado</a>. You can use <a href="http://flask.pocoo.org/docs/0.10/deploying/wsgi-standalone/#tornado">Flask over
Tornado</a>. But the issue with that is that Tornado needs you to
use it&#8217;s own networking <span class="caps">API</span> instead of the stdlib&#8217;s networking <span class="caps">API</span>. For example,
if you use the standard MySQL client with Tornado, it&#8217;s no good as Tornado&#8217;s
IOLoop will not be able to handle network requests unless you use Tornado&#8217;s
networking <span class="caps">API</span> and all requests to MySQL will block the IOLoop. So Tornado could
not be a drop-in&nbsp;solution.</p>
<p>Next in the list was <a href="http://gevent.org/">Gevent</a>. The awesome thing about Gevent is that it
allows you to monkey-patch Python stdlib&#8217;s modules that can be made non-blocking
with its own versions of those modules. That way you don&#8217;t have to adopt
anything new to make your applications non-blocking. Just keep using stdlib&#8217;s
modules and then monkey patch them and you have a non-blocking version of your
application ready. Its pretty much a drop-in replacement. Yes, things can be a
little more different and difficult rather than how simply they are described
above. So now was the time to try <a href="http://flask.pocoo.org/docs/0.10/deploying/wsgi-standalone/#gevent">Flask over Gevent</a>. Gevent
provides a <a href="http://gevent.org/gevent.wsgi.html#gevent.wsgi.WSGIHandler">WSGIServer</a> that can run any <span class="caps">WSGI</span> compliant app like Flask&#8217;s
apps. This worked like a charm and the problem of handling multiple concurrent
request was handled without much of an&nbsp;effort.</p>
<p>But as I said, things are not so easy. You only wish that they were. Everything
worked fine with the server implementation, except one - capturing access logs.
Gevent&#8217;s WSGIServer prints all access logs to <a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_error_.28stderr.29"><code>stderr</code></a> and provides no
way to override this behaviour via its APIs. Since access logs are critical for
debugging production issues and any other ad-hoc requirement that may arise in
the future, you have to capture them no matter what. In this case, the only way
you are left with is redirecting <code>stderr</code> to a file like&nbsp;so:</p>
<pre><code>python app.py 2&gt; /var/log/app.log
</code></pre>
<p>This works fine and you may actually use it if it works for you. However, while
building new applications and servers, you must consider in what ways and
conditions can your code get deployed. If you know that there can be changing
situations and environments from deployment-to-deployment, then you have to
make sure that the variables that change are configurable in some way or
another - most standard being configuration files. So a nice way to deal with
the situation would be to have the path for access logs file in your
configuration file and let your application send all access logs to a file at
that path, but how do you redirect logs to file whose path is in your
configuration file? There can be many ways, like if you plan to run your server
using init scripts, then have your init script parse the configuration file and
start the server with redirecting <code>stderr</code> stream to the correct access log file
according to your configuration file. But that seemed to much of unnecessary&nbsp;work.</p>
<p>Here is a solution that I propose. Since Gevent writes all the logs to <code>stderr</code>,
what we need to do is somehow redirect everything that is written to <code>stderr</code> to
another file. Since <a href="https://docs.python.org/2/library/sys.html#sys.stderr"><code>sys.stderr</code></a> is a file object, we can
monkey-patch <code>sys.stderr</code> with an object that overrides write&nbsp;method:</p>
<pre><code>class RedirectStderr(object):

    def __init__(self, cfg):
        self._log_file = open(cfg['access_log_path'], 'a')

    def write(self, msg):
        self._log_file.write(msg)
        self._log_file.flush()

import sys
sys.stderr = RedirectStderr(cfg)
</code></pre>
<p>This solution will work just fine and solve <em>almost</em> all our problems. The
problem is that it gives rise to other problems. Since <code>sys.stderr</code> is nothing
but a <a href="https://docs.python.org/2/library/stdtypes.html#bltin-file-objects"><code>file</code></a> object, we cannot be sure if Gevent is not using other
methods on <code>sys.stderr</code> elsewhere in the code. And yes we can find it, but there
is no point in doing all that. So a better solution would be subclassing <code>file</code>
class and overriding all that we need to&nbsp;override.</p>
<pre><code>class RedirectStderr(file):

    def __init__(self, *args, **kwargs):
        self._cfg = kwargs.pop('cfg')
        self._log_file = open(self._cfg['access_log_path'], 'a')
        super(RedirectStderr, self).__init__(*args, **kwargs)

    def write(self, msg):
        # Just in-case you want to write to both stderr and another log file
        super(RedirectStderr, self).write(msg)

        # Write to another access log file
        self._log_file.write(msg)
        self._log_file.flush()

        # Or use Python's logging facility to log the standard way you log
        # across your project
        log.info(msg)

import sys
sys.stderr = RedirectStderr('/dev/stderr', 'w', cfg=cfg)
</code></pre>
<p>This implementation will override only <code>sys.stderr.write</code> leave everything
intact so that any other use of <code>sys.stderr</code> does not break Gevent, and your&nbsp;application.</p>
<p>The <code>RedirectStderr</code> class is not meant to just work with <code>stderr</code>. If you
notice, we open <code>/dev/stderr</code> at the time of instantiating the class. So you can
use this hack to monkey-patch anything that follows the file interface in&nbsp;Python.</p>
<p>Hope this is a solution elegant enough for solving this problem. What do you
think? Can there be an improvement to this? Or do you have a different better
soltution? Would love to hear them in&nbsp;comments.</p>            </section>
        </article>

        <section>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'vaidikkapoor'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>
    </div>          </section>
      </div>

      <footer>
                              <nav >
        <a title="Home Page"
        class="home"
        href="/index.html">
        Home
    </a>    <a title="Blog Archives"
        class="active blog"
        href="/blog">
        Archives
    </a>    <a title="About"
        class="about"
        href="/about.html">
        About
    </a></nav>
                    <section class="credits">
              Built using <a href="http://ringce.com/hyde" target="_blank">Hyde</a>.
          </section>
      </footer>
      </div> <!--! end of #container -->
  
    <!-- Javascript at the bottom for fast page loading -->
    <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
  <script>window.jQuery || document.write('<script src="js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>
  
    <!-- Start Visual Website Optimizer Asynchronous Code -->
<script type='text/javascript'>
var _vwo_code=(function(){
var account_id=22676,
settings_tolerance=2000,
library_tolerance=2500,
use_existing_jquery=false,
// DO NOT EDIT BELOW THIS LINE
f=false,d=document;return{use_existing_jquery:function(){return use_existing_jquery;},library_tolerance:function(){return library_tolerance;},finish:function(){if(!f){f=true;var a=d.getElementById('_vis_opt_path_hides');if(a)a.parentNode.removeChild(a);}},finished:function(){return f;},load:function(a){var b=d.createElement('script');b.src=a;b.type='text/javascript';b.innerText;b.onerror=function(){_vwo_code.finish();};d.getElementsByTagName('head')[0].appendChild(b);},init:function(){settings_timer=setTimeout('_vwo_code.finish()',settings_tolerance);this.load('//dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(d.URL)+'&r='+Math.random());var a=d.createElement('style'),b='body{opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;}',h=d.getElementsByTagName('head')[0];a.setAttribute('id','_vis_opt_path_hides');a.setAttribute('type','text/css');if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(d.createTextNode(b));h.appendChild(a);return settings_timer;}};}());_vwo_settings_timer=_vwo_code.init();
</script>
<!-- End Visual Website Optimizer Asynchronous Code -->
  

  <!--[if lt IE 7 ]>
    <script src="js/libs/dd_belatedpng.js"></script>
    <script>DD_belatedPNG.fix('img, .png_bg'); // Fix any <img> or .png_bg bg-images. Also, please read goo.gl/mZiyb </script>
  <![endif]-->

    <!-- asynchronous google analytics: mathiasbynens.be/notes/async-analytics-snippet
       change the UA-XXXXX-X to be your site's ID -->
<script>
    var _gaq = [['_setAccount', ''], ['_trackPageview']];
    (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
    })(document, 'script');
</script>
  
  </body>
</html>