<!doctype html>
<!-- https://github.com/paulirish/html5-boilerplate/blob/master/index.html -->
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="">

  <!-- encoding must be specified within the first 512 bytes
        www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#charset -->

  <!-- meta element for compatibility mode needs to be before
        all elements except title & meta
        msdn.microsoft.com/en-us/library/cc288325(VS.85).aspx -->
  <!-- Chrome Frame is only invoked if meta element for
        compatibility mode is within the first 1K bytes
        code.google.com/p/chromium/issues/detail?id=23003 -->

  <title>Marg - A Simple Request Router written in PHP</title>
  <meta name="description" content="Marg is a simple request router written in PHP. This article introduces you to [Marg][MARG]'s API and how you can use it.">
  <meta name="author" content="Vaidik Kapoor">

  <meta prefix="og: http://ogp.me/ns#" property="og:title" content="Marg - A Simple Request Router written in PHP" />
  <meta prefix="og: http://ogp.me/ns#" property="og:description" content="Marg is a simple request router written in PHP. This article introduces you to [Marg][MARG]'s API and how you can use it." />

  <!--  Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="">

    <!-- Place favicon.ico & apple-touch-icon.png
        in the root of your domain and delete these references -->
  <link rel="shortcut icon" href="/media/favicon.ico">
  <link rel="apple-touch-icon" href="/media/apple-touch-icon.png">
  
  <!-- External Fonts -->
  <link href='http://fonts.googleapis.com/css?family=Mate+SC|Oxygen' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Balthazar' rel='stylesheet' type='text/css'>

  <!-- highlight.js -->
  <link rel="stylesheet" href="http://yandex.st/highlightjs/7.3/styles/default.min.css">
  <script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <link rel="canonical" href="https://medium.com/@vaidikkapoor/marg-a-simple-request-router-written-in-php-ee0caba9c239">

    <link rel="stylesheet" href="/media/css/site.css">
  <link rel="stylesheet" href="/media/css/syntax.css">
  
    <!-- All JavaScript at the bottom, except for Modernizr which
        enables HTML5 elements & feature detects -->
    <script src="/media/js/libs/modernizr-1.7.min.js"></script>
    </head>
<body id="marg">
    <div id="container">
            <div id="main" role="main">
          <header class="clearfix">
              <h1>Vaidik Kapoor</h1>
                                          <nav >
        <a title="Home Page"
        class="home"
        href="/index.html">
        Home
    </a>    <a title="Blog Archives"
        class="active blog"
        href="/blog">
        Archives
    </a>    <a title="About"
        class="about"
        href="/about.html">
        About
    </a></nav>
              
          </header>

          <section class="content">
              <div class="post">
        <article>
            <aside>
                <time datetime="2012-11-10">
                    November 10, 2012
                </time>
            </aside>
            <section>
                <h2>
                    <a href="">Marg - A Simple Request Router written in PHP</a>
                </h2>
                <p><a href="http://github.com/vaidikkp/marg">Marg</a> is a simple <span class="caps">HTTP</span> Request Router, written in <span class="caps">PHP</span>. It has a very simple <span class="caps">API</span>
and is motivated by my understanding and experience of using existing frameworks
like Django, Flask, Drupal and some other pieces of code I have read in the past.
Though I have written this code for my personal use, its free for anyone to use.
The idea behind writing <a href="http://github.com/vaidikkp/marg">Marg</a> was to have a boilerplate code for myself which I can
use for my own&nbsp;projects.</p>
<p><a href="http://github.com/vaidikkp/marg">Marg</a> has a really simple <span class="caps">API</span> and it is really easy to use. And one of the reasons
for this is that it does not do everything for you. It does not follow the 
Batteries Included philosophy. All it does for you is that it routes incoming <span class="caps">HTTP</span>
requests for you to the right request handlers. You may use functions or classes
to write your request handlers, and then you define routes for each
of those request&nbsp;handlers.</p>
<h3>The&nbsp;Code</h3>
<p>So lets just dive into some&nbsp;code:</p>
<pre><code>&lt;?php

include 'marg/marg.php';

$routes = array(
    '/' =&gt; 'home',
);

function home() {
    echo 'Hello World!';
}

Marg::run($routes);

?&gt;
</code></pre>
<p>So that&#8217;s a really simple example. What we have done here is that we have
defined a new function (controller) called &#8220;home&#8221;. This is basically a function and we want
it to handle our request everytime a client requests the &#8220;/&#8221; <span class="caps">URI</span>. So to do exactly
the same thing, we have defined this function and we have a $routes variable
to tell <a href="http://github.com/vaidikkp/marg">Marg</a> to route the incoming request to &#8220;/&#8221; to this request handler. $routes
is an associative array where the key is the <span class="caps">URI</span> for which you want to handle and the value
is the name of the request handler or an array (we will see this later) which will handle the
request. Finally, we call the run() method, passing the $routes variable to it as the only&nbsp;argument.</p>
<p>Now open the &#8220;/&#8221; <span class="caps">URI</span> in the browser and you will get a nice &#8220;Hello&nbsp;World!&#8221;.</p>
<p>Let&#8217;s make things a little more complex. Let&#8217;s handle different kinds of&nbsp;requests.</p>
<pre><code>&lt;?php

include 'marg/marg.php';

$routes = array(
    '/' =&gt; 'home',
);

function home() {

    echo '&lt;h1&gt;Hello World!&lt;/h1&gt;';

    global $request;

    if ($request-&gt;verb == 'GET') {
        echo 'This is a GET request.';
    } else {
        header('HTTP/1.1 405 Method Not Allowed');
        echo 'Method Not Allowed';
    }
}

Marg::run($routes);

?&gt;
</code></pre>
<p>In the above example, we have explicitly made sure that our home controller handles
only <span class="caps">GET</span> requests. Rather, we want all the non-<span class="caps">GET</span> requests to get rejected. The right
way of doing this is by sending the 405 Method Not Allowed response header. Since <span class="caps">PHP</span>
was made for the web, you can determine the type of request through many ways. However,
<a href="http://github.com/vaidikkp/marg">Marg</a> simplifies it for you so that you don&#8217;t have to take care of this all the time.
<a href="http://github.com/vaidikkp/marg">Marg</a> provides you with a $request global object that has information about the incoming
request. The &#8220;verb&#8221; property of the $request object tells you the &#8220;<span class="caps">HTTP</span> verb&#8221; or <span class="caps">HTTP</span>
method used for the incoming request. As you can see, we have added a short snippet to
check the method and if it is not <span class="caps">GET</span>, then we send the appropriate header and&nbsp;response.</p>
<p>Another way to do this is implement a &#8220;raise&#8221; function. The way to do that is&nbsp;this:</p>
<pre><code>&lt;?php

function home() {
    echo '&lt;h1&gt;Hello World!&lt;/h1&gt;';

    global $request;

    if ($request-&gt;verb == 'GET') {
        echo 'This is a GET request.';
    } else {
        raise('405');
    }
}

function raise_405() {
    header('HTTP/1.1 405 Method Not Allowed');
    echo '&lt;h1&gt;405: Method Not Allowed&lt;/h1&gt;';
}

?&gt;
</code></pre>
<p><span class="dquo">&#8220;</span>raise&#8221; is used to raise what I call <span class="caps">HTTP</span> exceptions. They are not exceptions like exceptions
in <span class="caps">PHP</span> or any programming language for that matter. These are essentially functions that you
might want to use to keep your code clean and readable. The way to do this is implement a 
function named in the following format: raise_HTTP_CODE. So to raise a 405 <span class="caps">HTTP</span> exception,
all you have to do is call the raise() function with the code as an argument, like so:&nbsp;raise(&#8216;405&#8217;).</p>
<p>raise() function exists for improving code readability and nothing else only as of now.
It does not do much right now, but there is more that I want to do with it in the future -
just haven&#8217;t found a way to do it&nbsp;yet.</p>
<p>The above example can also be implemented like&nbsp;so:</p>
<pre><code>&lt;?php

include 'marg/marg.php';

$routes = array(
    '/' =&gt; array('home', array('GET', 'POST')),
);

function home() {
    echo 'Hello World!';
}

Marg::run($routes);

?&gt;
</code></pre>
<p>This way you can inform <a href="http://github.com/vaidikkp/marg">Marg</a> about which methods your controller will handle and if a request
comes in with an <span class="caps">HTTP</span> method not specified in that array, then a 405 is&nbsp;raised.</p>
<p>Alternatively, you may also write the same $routes variable like&nbsp;so:</p>
<pre><code>&lt;?php

$routes = array(
    '/' =&gt; array(
        'controller' =&gt; 'home',
        'methods' =&gt; array('GET', 'POST')
    ),
);

?&gt;
</code></pre>
<p>The above method is just another explicit way of expressing what we did in the previous&nbsp;example.</p>
<p>We have seen how to use functions to handle your requests. Now, lets take a look at how you&#8217;d do
the same thing using classes in <span class="caps">PHP</span>.</p>
<pre><code>&lt;?php

include 'marg/marg.php';

$routes = array(
    '/' =&gt; array('home', array('GET', 'POST')),
    '/classes' =&gt; 'ClassesExample',
);

function home() { 
    ...
}

class ClassesExample {
    public function get() {
        echo '&lt;h1&gt;This is an example of how to use classes with [Marg][MARG].&lt;/h1&gt;';
        echo '&lt;p&gt;This is a GET request.&lt;/p&gt;';
    }

    public function post() {
        echo '&lt;h1&gt;This is an example of how to use classes with [Marg][MARG].&lt;/h1&gt;';
        echo '&lt;p&gt;This is a POST request.&lt;/p&gt;';
    }
};

Marg::run($routes);

?&gt;
</code></pre>
<p>In the above example, we have used a class instead of a function. And our class implements
a get() method and a post() method to handle <span class="caps">GET</span> and <span class="caps">POST</span> requests coming to &#8220;/classes&#8221; <span class="caps">URI</span>.
That&#8217;s all we have to do to handle different requests separately. If an incoming request is
not a <span class="caps">GET</span> or <span class="caps">POST</span> request (say it is a <span class="caps">PUT</span> request), then a 405 will be&nbsp;raised.</p>
<h3>setUp and&nbsp;tearDown</h3>
<p><a href="http://github.com/vaidikkp/marg">Marg</a> also allows you to define setUp and tearDown for incoming requests at two different
levels. To define a setUp and a tearDown for all the incoming requests i.e. the global level,
this is what you&#8217;d&nbsp;do:</p>
<pre><code>&lt;?php

include 'marg/marg.php';

$routes = array(
    '/' =&gt; array('home', array('GET', 'POST')),
);

function home() {
    echo 'Hello World!';
}

Marg::run($routes);
Marg::addSetUp(function () {  echo '&lt;html&gt;&lt;head&gt;&lt;title&gt;Marg Examples&lt;/title&gt;&lt;/head&gt;&lt;body&gt;'; });
Marg::addTearDown(function () { echo '&lt;/body&gt;&lt;/html&gt;'; });

?&gt;
</code></pre>
<p>Every time you get an incoming request, first the global setUp callback will be called, then the
controller is called and then the global tearDown callback will be called. In this example, we
have used an anonymous function available in <span class="caps">PHP</span>&nbsp;5.3+.</p>
<p>You may also add setUp and tearDown at controller levels like&nbsp;so:</p>
<pre><code>&lt;?php

class ClassesExample {
    public function setUp() {
        echo '&lt;h1&gt;This is an example of how to use classes with [Marg][MARG].&lt;/h1&gt;';
        echo '&lt;center&gt;';
    }

    public function tearDown() {
        echo '&lt;/center&gt;';
    }

    public function get() {
        echo '&lt;p&gt;This is a GET request.&lt;/p&gt;';
    }

    public function post() {
        echo '&lt;h1&gt;This is an example of how to use classes with [Marg][MARG].&lt;/h1&gt;';
        echo '&lt;p&gt;This is a POST request.&lt;/p&gt;';
    }
};

?&gt;
</code></pre>
<p>So now when a request comes in, the global setUp is called first, then the setUp at class level
is called, then the class method is called, then the class tearDown is called and finally the
global tearDown is&nbsp;called.</p>
<p><strong>Please note</strong> that you can use setUp and tearDown at controller levels only with classes and
not with&nbsp;functions.</p>
<h3>Responses</h3>
<p>You must have noticed that <a href="http://github.com/vaidikkp/marg">Marg</a> does not provide any way of simplifying how you generate
your responses. Well, there can be a lot of things that I could have done on that front but
that would have been really a lot of opiniated design decisions that I did not want to
enforce onto others and myself as well because I do tend to change how I write my applications
with time and experience. So how you handle your responses depends entirely on you. You may
want to use a templating engine like <a href="http://www.smarty.net/">Smarty</a> or may be you want to write a custom response
generation engine yourself. Its up to&nbsp;you!</p>
<h3>How and&nbsp;why?</h3>
<p>While I was interning at <a href="https://wingify.com">Wingify</a> (the creators of <a href="http://visualwebsiteoptimizer.com">Visual Website Optimizer</a>, check
it out in case you don&#8217;t know what it is &#8216;coz its awesome!), one of the projects I
was working on was development of a <span class="caps">REST</span> <span class="caps">API</span> for <a href="http://visualwebsiteoptimizer.com">Visual Website Optimizer</a> (<span class="caps">VWO</span>).
I hadn&#8217;t worked on a dedicated <span class="caps">REST</span> <span class="caps">API</span> before this, mostly because there was 
never a need to do the same. But I&#8217;d always think of working on one for a project,
just didn&#8217;t know that it would be <a href="http://visualwebsiteoptimizer.com"><span class="caps">VWO</span></a>. Anyways, I wanted to get everything right
and so I started to read about <span class="caps">API</span> design and best practices. While doing this,
one good thing that happened with me was that I got in the habbit of reading
specs. I read many parts of the <span class="caps">HTTP</span> 1.1 spec many times. I read docs of many
web services&#8217; APIs like Github&#8217;s, Facebook&#8217;s, Google Data Protocol&#8217;s, and many
more. And, I got to learn a great deal of things, how they are done, why they are
done,&nbsp;etc.</p>
<p>Put together the knowledge and experience I had gathered by using various 
frameworks over the last couple of years and all the information and the new 
things that I had gathered while learning about <span class="caps">API</span> design and best practices, I
started working on designing the <span class="caps">API</span> spec and then started writing code for the
same. It was an amazing experience. After every addition to the code base, I used
to validate my work with the best practices I had layed down for our use case. And
in the whole process I learned a lot of&nbsp;things.</p>
<p>Sometime back, I was working on a small weekend project and had to write an <span class="caps">API</span> for it
that would send responses in <span class="caps">JSON</span>. After working on it for a while, I realized my 
approach and code were quite similar to the one I applied while working on the <a href="http://visualwebsiteoptimizer.com"><span class="caps">VWO</span></a>
<span class="caps">API</span> project. Therefore, I decided to make use of all the things I learned while working
at <a href="https://wingify.com">Wingify</a> and write my own boilerplate code for my own use. So this became my new weekend
project which resulted in <a href="http://github.com/vaidikkp/marg">Marg</a>.</p>
<p>I thank <a href="https://wingify.com">Wingify</a> here for giving me the opportunity to work on that project. I got the 
opportunity to learn a great deal through the project I was asked to work&nbsp;on!</p>
<h3>Feedback</h3>
<p><a href="http://github.com/vaidikkp/marg">Marg</a> was more of a weekend project. I have added code to it but haven&#8217;t been able to really
devote time to it. I am sure it has some glitches. I&#8217;d be really happy to have some feedback.
So, please take out some time and let me know how you feel about&nbsp;it.</p>            </section>
        </article>

        <section>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'vaidikkapoor'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>
    </div>          </section>
      </div>

      <footer>
                              <nav >
        <a title="Home Page"
        class="home"
        href="/index.html">
        Home
    </a>    <a title="Blog Archives"
        class="active blog"
        href="/blog">
        Archives
    </a>    <a title="About"
        class="about"
        href="/about.html">
        About
    </a></nav>
                    <section class="credits">
              Built using <a href="http://ringce.com/hyde" target="_blank">Hyde</a>.
          </section>
      </footer>
      </div> <!--! end of #container -->
  
    <!-- Javascript at the bottom for fast page loading -->
    <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
  <script>window.jQuery || document.write('<script src="js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>
  
    <script type="text/javascript">
  window.heap=window.heap||[],heap.load=function(t,e){window.heap.appid=t,window.heap.config=e;var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https:":"http:")+"//cdn.heapanalytics.com/js/heap.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(t){return function(){heap.push([t].concat(Array.prototype.slice.call(arguments,0)))}},p=["clearEventProperties","identify","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
  heap.load("2141231414");
</script>
  <!-- Start Visual Website Optimizer Asynchronous Code -->
<script type='text/javascript'>
var _vwo_code=(function(){
var account_id=22676,
settings_tolerance=2000,
library_tolerance=2500,
use_existing_jquery=false,
// DO NOT EDIT BELOW THIS LINE
f=false,d=document;return{use_existing_jquery:function(){return use_existing_jquery;},library_tolerance:function(){return library_tolerance;},finish:function(){if(!f){f=true;var a=d.getElementById('_vis_opt_path_hides');if(a)a.parentNode.removeChild(a);}},finished:function(){return f;},load:function(a){var b=d.createElement('script');b.src=a;b.type='text/javascript';b.innerText;b.onerror=function(){_vwo_code.finish();};d.getElementsByTagName('head')[0].appendChild(b);},init:function(){settings_timer=setTimeout('_vwo_code.finish()',settings_tolerance);this.load('//dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(d.URL)+'&r='+Math.random());var a=d.createElement('style'),b='body{opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;}',h=d.getElementsByTagName('head')[0];a.setAttribute('id','_vis_opt_path_hides');a.setAttribute('type','text/css');if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(d.createTextNode(b));h.appendChild(a);return settings_timer;}};}());_vwo_settings_timer=_vwo_code.init();
</script>
<!-- End Visual Website Optimizer Asynchronous Code -->
  

  <!--[if lt IE 7 ]>
    <script src="js/libs/dd_belatedpng.js"></script>
    <script>DD_belatedPNG.fix('img, .png_bg'); // Fix any <img> or .png_bg bg-images. Also, please read goo.gl/mZiyb </script>
  <![endif]-->

    <!-- asynchronous google analytics: mathiasbynens.be/notes/async-analytics-snippet
       change the UA-XXXXX-X to be your site's ID -->
<script>
    var _gaq = [['_setAccount', ''], ['_trackPageview']];
    (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
    })(document, 'script');
</script>
  
  </body>
</html>